# åŸºäºASTçš„Pythonä»£ç å®‰å…¨æ¼æ´é™æ€åˆ†æå·¥å…·

---

**è¯¾ç¨‹åç§°ï¼š** å¼€æºè½¯ä»¶æŠ€æœ¯

**é¡¹ç›®åç§°ï¼š** PySecScanner - Pythonä»£ç å®‰å…¨æ¼æ´é™æ€åˆ†æå·¥å…·

**å®Œæˆæ—¥æœŸï¼š** 2026å¹´1æœˆ

---

## æ‘˜è¦

éšç€Pythonåœ¨Webå¼€å‘ã€æ•°æ®ç§‘å­¦ã€è‡ªåŠ¨åŒ–è„šæœ¬ç­‰é¢†åŸŸçš„å¹¿æ³›åº”ç”¨ï¼ŒPythonä»£ç çš„å®‰å…¨æ€§é—®é¢˜æ—¥ç›Šçªå‡ºã€‚æœ¬é¡¹ç›®åŸºäºPythonæ ‡å‡†åº“ä¸­çš„ASTï¼ˆAbstract Syntax Treeï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼‰æ¨¡å—ï¼Œè®¾è®¡å¹¶å®ç°äº†ä¸€ä¸ªè½»é‡çº§çš„Pythonä»£ç å®‰å…¨æ¼æ´é™æ€åˆ†æå·¥å…·â€”â€”PySecScannerã€‚

è¯¥å·¥å…·èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹Pythonæºä»£ç ä¸­å¸¸è§çš„å®‰å…¨æ¼æ´ï¼ŒåŒ…æ‹¬ï¼šSQLæ³¨å…¥é£é™©ã€å‘½ä»¤æ³¨å…¥é£é™©ã€ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ã€å±é™©å‡½æ•°è°ƒç”¨ã€ä¸å®‰å…¨çš„ååºåˆ—åŒ–æ“ä½œç­‰ã€‚é€šè¿‡å¯¹ä»£ç è¿›è¡Œè¯­æ³•æ ‘è§£æå’Œæ¨¡å¼åŒ¹é…ï¼Œå·¥å…·å¯ä»¥åœ¨ä¸æ‰§è¡Œä»£ç çš„æƒ…å†µä¸‹å‘ç°æ½œåœ¨çš„å®‰å…¨éšæ‚£ã€‚

æœ¬é¡¹ç›®å……åˆ†åˆ©ç”¨äº†å¼€æºè½¯ä»¶æŠ€æœ¯ï¼Œé‡‡ç”¨Python ASTæ¨¡å—è¿›è¡Œè¯­æ³•åˆ†æï¼Œå‚è€ƒäº†ä¸šç•ŒçŸ¥åå®‰å…¨æ‰«æå·¥å…·ï¼ˆå¦‚Banditã€Semgrepï¼‰çš„è®¾è®¡ç†å¿µï¼Œå¹¶å€Ÿé‰´äº†DeepAuditç­‰AIå®¡è®¡å·¥å…·çš„æ¼æ´æ£€æµ‹è§„åˆ™ã€‚å®éªŒç»“æœè¡¨æ˜ï¼Œè¯¥å·¥å…·èƒ½å¤Ÿæœ‰æ•ˆæ£€æµ‹å¤šç§å¸¸è§å®‰å…¨æ¼æ´ï¼Œå…·æœ‰ä¸€å®šçš„å®ç”¨ä»·å€¼ã€‚

**å…³é”®è¯ï¼š** é™æ€åˆ†æï¼›ASTï¼›Pythonå®‰å…¨ï¼›æ¼æ´æ£€æµ‹ï¼›å¼€æºè½¯ä»¶

---

## ç›®å½•

1. [å¼•è¨€](#1-å¼•è¨€)
   - 1.1 ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰
   - 1.2 å›½å†…å¤–ç ”ç©¶ç°çŠ¶
   - 1.3 æœ¬æ–‡ä¸»è¦å·¥ä½œ
2. [éœ€æ±‚åˆ†æ](#2-éœ€æ±‚åˆ†æ)
   - 2.1 åŠŸèƒ½éœ€æ±‚
   - 2.2 éåŠŸèƒ½éœ€æ±‚
   - 2.3 ç”¨ä¾‹åˆ†æ
3. [ç³»ç»Ÿè®¾è®¡](#3-ç³»ç»Ÿè®¾è®¡)
   - 3.1 æ€»ä½“æ¶æ„è®¾è®¡
   - 3.2 æ¨¡å—è®¾è®¡
   - 3.3 æ£€æµ‹è§„åˆ™è®¾è®¡
   - 3.4 æ•°æ®ç»“æ„è®¾è®¡
4. [ç³»ç»Ÿå®ç°](#4-ç³»ç»Ÿå®ç°)
   - 4.1 å¼€å‘ç¯å¢ƒ
   - 4.2 æ ¸å¿ƒæ¨¡å—å®ç°
   - 4.3 æ£€æµ‹è§„åˆ™å®ç°
   - 4.4 æŠ¥å‘Šç”Ÿæˆå®ç°
5. [ç³»ç»Ÿæµ‹è¯•](#5-ç³»ç»Ÿæµ‹è¯•)
   - 5.1 æµ‹è¯•ç¯å¢ƒ
   - 5.2 å•å…ƒæµ‹è¯•
   - 5.3 é›†æˆæµ‹è¯•
   - 5.4 çœŸå®é¡¹ç›®æµ‹è¯•
6. [æ€»ç»“ä¸å±•æœ›](#6-æ€»ç»“ä¸å±•æœ›)
   - 6.1 å·¥ä½œæ€»ç»“
   - 6.2 ä¸è¶³ä¸æ”¹è¿›æ–¹å‘
7. [å‚è€ƒæ–‡çŒ®](#7-å‚è€ƒæ–‡çŒ®)
8. [é™„å½•](#8-é™„å½•)

---

## 1. å¼•è¨€

### 1.1 ç ”ç©¶èƒŒæ™¯ä¸æ„ä¹‰

Pythonä½œä¸ºä¸€é—¨ç®€æ´ã€æ˜“è¯»ã€åŠŸèƒ½å¼ºå¤§çš„ç¼–ç¨‹è¯­è¨€ï¼Œè¿‘å¹´æ¥åœ¨å„ä¸ªé¢†åŸŸå¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚æ ¹æ®TIOBEç¼–ç¨‹è¯­è¨€æ’è¡Œæ¦œï¼ŒPythonå·²è¿ç»­å¤šå¹´ä½å±…å‰ä¸‰ï¼Œæˆä¸ºæœ€å—æ¬¢è¿çš„ç¼–ç¨‹è¯­è¨€ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œéšç€Pythonåº”ç”¨çš„æ™®åŠï¼Œå…¶å®‰å…¨é—®é¢˜ä¹Ÿæ—¥ç›Šå‡¸æ˜¾ã€‚

æ ¹æ®OWASPï¼ˆå¼€æ”¾Webåº”ç”¨å®‰å…¨é¡¹ç›®ï¼‰ç»Ÿè®¡ï¼Œæ³¨å…¥æ”»å‡»ï¼ˆåŒ…æ‹¬SQLæ³¨å…¥ã€å‘½ä»¤æ³¨å…¥ç­‰ï¼‰é•¿æœŸä½å±…Webåº”ç”¨å®‰å…¨å¨èƒæ¦œé¦–ã€‚æ­¤å¤–ï¼Œç¡¬ç¼–ç å¯†é’¥ã€ä¸å®‰å…¨çš„ååºåˆ—åŒ–ã€å±é™©å‡½æ•°è°ƒç”¨ç­‰é—®é¢˜ä¹Ÿé¢‘ç¹å‡ºç°åœ¨Pythoné¡¹ç›®ä¸­ã€‚2025å¹´CVEæ•°æ®åº“ä¸­ï¼Œä¸Pythonç›¸å…³çš„å®‰å…¨æ¼æ´æ•°é‡è¾ƒå¾€å¹´å¢é•¿äº†çº¦30%ã€‚

ä¼ ç»Ÿçš„ä»£ç å®¡è®¡ä¸»è¦ä¾èµ–äººå·¥å®¡æŸ¥ï¼Œæ•ˆç‡ä½ä¸‹ä¸”å®¹æ˜“é—æ¼ã€‚é™æ€åº”ç”¨å®‰å…¨æµ‹è¯•ï¼ˆSASTï¼‰æŠ€æœ¯é€šè¿‡åœ¨ä¸æ‰§è¡Œä»£ç çš„æƒ…å†µä¸‹åˆ†ææºä»£ç ï¼Œèƒ½å¤Ÿåœ¨å¼€å‘æ—©æœŸå‘ç°æ½œåœ¨çš„å®‰å…¨æ¼æ´ï¼Œæ˜¯æé«˜ä»£ç å®‰å…¨æ€§çš„é‡è¦æ‰‹æ®µã€‚

æœ¬é¡¹ç›®æ—¨åœ¨å¼€å‘ä¸€ä¸ªåŸºäºASTçš„Pythonä»£ç å®‰å…¨æ¼æ´é™æ€åˆ†æå·¥å…·ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨ä»£ç æäº¤å‰è‡ªåŠ¨æ£€æµ‹å¸¸è§å®‰å…¨é—®é¢˜ï¼Œæé«˜å¼€å‘æ•ˆç‡å’Œä»£ç å®‰å…¨æ€§ã€‚

### 1.2 å›½å†…å¤–ç ”ç©¶ç°çŠ¶

ç›®å‰ï¼Œä¸šç•Œå·²æœ‰å¤šç§æˆç†Ÿçš„Pythonå®‰å…¨æ‰«æå·¥å…·ï¼š

| å·¥å…·åç§° | å¼€å‘è€… | ç‰¹ç‚¹ | å±€é™æ€§ |
|---------|--------|------|--------|
| Bandit | PyCQA | OpenStackå®˜æ–¹æ¨èï¼Œè§„åˆ™ä¸°å¯Œ | è¯¯æŠ¥ç‡è¾ƒé«˜ï¼Œç¼ºä¹æ•°æ®æµåˆ†æ |
| Semgrep | r2c | æ”¯æŒå¤šè¯­è¨€ï¼Œè§„åˆ™å¯è‡ªå®šä¹‰ | å­¦ä¹ æ›²çº¿é™¡å³­ï¼Œé…ç½®å¤æ‚ |
| Pylint | PyCQA | ä»£ç è´¨é‡æ£€æŸ¥ä¸ºä¸» | å®‰å…¨æ£€æµ‹èƒ½åŠ›æœ‰é™ |
| DeepAudit | lintsinghua | AIé©±åŠ¨ï¼ŒMulti-Agentæ¶æ„ | éœ€è¦LLM APIï¼Œèµ„æºæ¶ˆè€—å¤§ |

è¿‘å¹´æ¥ï¼ŒåŸºäºæœºå™¨å­¦ä¹ å’Œå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„ä»£ç å®¡è®¡å·¥å…·é€æ¸å…´èµ·ã€‚ä¾‹å¦‚DeepAudité‡‡ç”¨Multi-Agentåä½œæ¶æ„ï¼Œé€šè¿‡RAGçŸ¥è¯†åº“å¢å¼ºæ¼æ´æ£€æµ‹èƒ½åŠ›ã€‚ç„¶è€Œï¼Œè¿™ç±»å·¥å…·é€šå¸¸éœ€è¦è¾ƒé«˜çš„è®¡ç®—èµ„æºå’ŒAPIè´¹ç”¨ï¼Œä¸é€‚åˆè½»é‡çº§åœºæ™¯ã€‚

æœ¬é¡¹ç›®é€‰æ‹©åŸºäºASTçš„ä¼ ç»Ÿé™æ€åˆ†ææ–¹æ³•ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š
1. **è½»é‡çº§**ï¼šæ— éœ€å¤–éƒ¨ä¾èµ–ï¼Œçº¯Pythonå®ç°
2. **å¿«é€Ÿ**ï¼šç§’çº§å®Œæˆæ‰«æ
3. **å¯ç¦»çº¿**ï¼šæ— éœ€ç½‘ç»œè¿æ¥
4. **å¯æ‰©å±•**ï¼šè§„åˆ™æ˜“äºæ·»åŠ å’Œä¿®æ”¹

### 1.3 æœ¬æ–‡ä¸»è¦å·¥ä½œ

æœ¬é¡¹ç›®çš„ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼š

1. **è°ƒç ”åˆ†æ**ï¼šç ”ç©¶ç°æœ‰Pythonå®‰å…¨æ‰«æå·¥å…·çš„å®ç°åŸç†å’Œæ£€æµ‹è§„åˆ™
2. **æ¶æ„è®¾è®¡**ï¼šè®¾è®¡æ¨¡å—åŒ–ã€å¯æ‰©å±•çš„å·¥å…·æ¶æ„
3. **è§„åˆ™å®ç°**ï¼šå®ç°6ç±»å¸¸è§å®‰å…¨æ¼æ´çš„æ£€æµ‹è§„åˆ™
4. **å·¥å…·å¼€å‘**ï¼šå®Œæˆå‘½ä»¤è¡Œå·¥å…·å’ŒæŠ¥å‘Šç”ŸæˆåŠŸèƒ½
5. **æµ‹è¯•éªŒè¯**ï¼šåœ¨å¤šä¸ªå¼€æºé¡¹ç›®ä¸Šè¿›è¡Œæµ‹è¯•éªŒè¯

---

## 2. éœ€æ±‚åˆ†æ

### 2.1 åŠŸèƒ½éœ€æ±‚

#### 2.1.1 æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

| ç¼–å· | åŠŸèƒ½åç§° | åŠŸèƒ½æè¿° | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| FR-01 | å•æ–‡ä»¶æ‰«æ | æ”¯æŒå¯¹å•ä¸ªPythonæ–‡ä»¶è¿›è¡Œå®‰å…¨æ‰«æ | é«˜ |
| FR-02 | ç›®å½•æ‰«æ | æ”¯æŒå¯¹æ•´ä¸ªç›®å½•ï¼ˆé¡¹ç›®ï¼‰è¿›è¡Œé€’å½’æ‰«æ | é«˜ |
| FR-03 | SQLæ³¨å…¥æ£€æµ‹ | æ£€æµ‹å­—ç¬¦ä¸²æ‹¼æ¥æ„é€ SQLè¯­å¥çš„é£é™© | é«˜ |
| FR-04 | å‘½ä»¤æ³¨å…¥æ£€æµ‹ | æ£€æµ‹os.systemã€subprocessç­‰å‘½ä»¤æ‰§è¡Œé£é™© | é«˜ |
| FR-05 | ç¡¬ç¼–ç æ£€æµ‹ | æ£€æµ‹ä»£ç ä¸­ç¡¬ç¼–ç çš„å¯†ç ã€å¯†é’¥ã€Tokenç­‰ | é«˜ |
| FR-06 | å±é™©å‡½æ•°æ£€æµ‹ | æ£€æµ‹evalã€execã€pickle.loadsç­‰å±é™©å‡½æ•°è°ƒç”¨ | é«˜ |
| FR-07 | è·¯å¾„éå†æ£€æµ‹ | æ£€æµ‹æ–‡ä»¶æ“ä½œä¸­çš„è·¯å¾„éå†é£é™© | ä¸­ |
| FR-08 | XSSæ£€æµ‹ | æ£€æµ‹Webæ¡†æ¶ä¸­çš„XSSé£é™©ç‚¹ | ä¸­ |
| FR-09 | æŠ¥å‘Šç”Ÿæˆ | ç”ŸæˆJSON/Markdown/HTMLæ ¼å¼çš„æ‰«ææŠ¥å‘Š | é«˜ |
| FR-10 | è§„åˆ™é…ç½® | æ”¯æŒå¯ç”¨/ç¦ç”¨ç‰¹å®šæ£€æµ‹è§„åˆ™ | ä¸­ |

#### 2.1.2 æ£€æµ‹è§„åˆ™è¯¦ç»†è¯´æ˜

**1. SQLæ³¨å…¥æ£€æµ‹ï¼ˆFR-03ï¼‰**

æ£€æµ‹æ¨¡å¼ï¼š
- å­—ç¬¦ä¸²æ ¼å¼åŒ–æ‹¼æ¥SQLè¯­å¥ï¼š`"SELECT * FROM users WHERE id = %s" % user_id`
- f-stringæ‹¼æ¥SQLè¯­å¥ï¼š`f"SELECT * FROM users WHERE id = {user_id}"`
- å­—ç¬¦ä¸²è¿æ¥æ‹¼æ¥SQLè¯­å¥ï¼š`"SELECT * FROM users WHERE id = " + user_id`

**2. å‘½ä»¤æ³¨å…¥æ£€æµ‹ï¼ˆFR-04ï¼‰**

æ£€æµ‹ç›®æ ‡å‡½æ•°ï¼š
- `os.system()`
- `os.popen()`
- `subprocess.call()` / `subprocess.run()` / `subprocess.Popen()`ï¼ˆå½“shell=Trueæ—¶ï¼‰
- `commands.getoutput()`ï¼ˆPython 2ï¼‰

**3. ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯æ£€æµ‹ï¼ˆFR-05ï¼‰**

æ£€æµ‹æ¨¡å¼ï¼š
- å˜é‡ååŒ…å«ï¼špassword, passwd, pwd, secret, token, api_key, apikey, access_keyç­‰
- èµ‹å€¼ä¸ºå­—ç¬¦ä¸²å­—é¢é‡
- æ’é™¤æ˜æ˜¾çš„å ä½ç¬¦ï¼ˆå¦‚"xxx", "changeme", "your_password_here"ç­‰ï¼‰

**4. å±é™©å‡½æ•°æ£€æµ‹ï¼ˆFR-06ï¼‰**

| å±é™©å‡½æ•° | é£é™©ç±»å‹ | å±é™©ç­‰çº§ |
|---------|---------|---------|
| eval() | ä»»æ„ä»£ç æ‰§è¡Œ | ä¸¥é‡ |
| exec() | ä»»æ„ä»£ç æ‰§è¡Œ | ä¸¥é‡ |
| compile() | ä»£ç ç¼–è¯‘æ‰§è¡Œ | é«˜ |
| pickle.loads() | ååºåˆ—åŒ–RCE | ä¸¥é‡ |
| pickle.load() | ååºåˆ—åŒ–RCE | ä¸¥é‡ |
| yaml.load() | ä¸å®‰å…¨YAMLè§£æ | é«˜ |
| marshal.loads() | ååºåˆ—åŒ–é£é™© | é«˜ |

**5. è·¯å¾„éå†æ£€æµ‹ï¼ˆFR-07ï¼‰**

æ£€æµ‹æ¨¡å¼ï¼š
- `open()` å‡½æ•°å‚æ•°æ¥è‡ªç”¨æˆ·è¾“å…¥
- `os.path.join()` æœªå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œæ ¡éªŒ
- æ–‡ä»¶æ“ä½œå‡½æ•°ï¼ˆread, write, deleteï¼‰çš„è·¯å¾„å‚æ•°

**6. XSSæ£€æµ‹ï¼ˆFR-08ï¼‰**

æ£€æµ‹ç›®æ ‡ï¼š
- Flask: `render_template_string()` ä½¿ç”¨ç”¨æˆ·è¾“å…¥
- Django: `mark_safe()` åŒ…è£…ç”¨æˆ·è¾“å…¥
- ç›´æ¥è¿”å›æœªè½¬ä¹‰çš„HTMLå†…å®¹

### 2.2 éåŠŸèƒ½éœ€æ±‚

| ç¼–å· | éœ€æ±‚ç±»å‹ | éœ€æ±‚æè¿° |
|------|---------|---------|
| NFR-01 | æ€§èƒ½ | æ‰«æé€Ÿåº¦ > 1000è¡Œ/ç§’ |
| NFR-02 | å…¼å®¹æ€§ | æ”¯æŒPython 3.8+ |
| NFR-03 | å¯æ‰©å±•æ€§ | æ”¯æŒè‡ªå®šä¹‰æ£€æµ‹è§„åˆ™ |
| NFR-04 | æ˜“ç”¨æ€§ | æä¾›å‘½ä»¤è¡Œæ¥å£ï¼Œå¼€ç®±å³ç”¨ |
| NFR-05 | å‡†ç¡®æ€§ | è¯¯æŠ¥ç‡ < 30% |
| NFR-06 | å¯ç»´æŠ¤æ€§ | ä»£ç æ³¨é‡Šè¦†ç›–ç‡ > 50% |

### 2.3 ç”¨ä¾‹åˆ†æ

#### 2.3.1 ç”¨ä¾‹å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           PySecScanner                   â”‚
                    â”‚                                          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”¼â”€>â”‚  æ‰«æå•æ–‡ä»¶   â”‚  â”‚  æ‰«æç›®å½•    â”‚     â”‚
    â”‚ å¼€å‘è€… â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
    â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”¼â”€>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚  æŸ¥çœ‹æŠ¥å‘Š     â”‚  â”‚  é…ç½®è§„åˆ™    â”‚     â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                    â”‚                                          â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                    â”‚  â”‚  å¯¼å‡ºæŠ¥å‘Š     â”‚  â”‚  é›†æˆCI/CD   â”‚     â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.2 å…¸å‹ç”¨ä¾‹æè¿°

**ç”¨ä¾‹1ï¼šæ‰«æå•ä¸ªPythonæ–‡ä»¶**

| é¡¹ç›® | æè¿° |
|------|------|
| ç”¨ä¾‹åç§° | æ‰«æå•ä¸ªPythonæ–‡ä»¶ |
| å‚ä¸è€… | å¼€å‘è€… |
| å‰ç½®æ¡ä»¶ | å·²å®‰è£…PySecScanner |
| åŸºæœ¬æµç¨‹ | 1. ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ `pysec scan file.py`<br>2. å·¥å…·è§£ææ–‡ä»¶ç”ŸæˆAST<br>3. åº”ç”¨æ‰€æœ‰æ£€æµ‹è§„åˆ™<br>4. æ”¶é›†å‘ç°çš„æ¼æ´<br>5. è¾“å‡ºæ‰«æç»“æœ |
| åç½®æ¡ä»¶ | æ˜¾ç¤ºæ¼æ´åˆ—è¡¨æˆ–"æœªå‘ç°é—®é¢˜" |
| å¼‚å¸¸æµç¨‹ | æ–‡ä»¶ä¸å­˜åœ¨æˆ–è¯­æ³•é”™è¯¯æ—¶æç¤ºé”™è¯¯ä¿¡æ¯ |

**ç”¨ä¾‹2ï¼šç”Ÿæˆæ‰«ææŠ¥å‘Š**

| é¡¹ç›® | æè¿° |
|------|------|
| ç”¨ä¾‹åç§° | ç”Ÿæˆæ‰«ææŠ¥å‘Š |
| å‚ä¸è€… | å¼€å‘è€… |
| å‰ç½®æ¡ä»¶ | å·²å®Œæˆä»£ç æ‰«æ |
| åŸºæœ¬æµç¨‹ | 1. ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ `pysec scan project/ -o report.md`<br>2. å·¥å…·æ‰§è¡Œæ‰«æ<br>3. æ”¶é›†æ‰€æœ‰æ¼æ´ä¿¡æ¯<br>4. æŒ‰æ¨¡æ¿ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶<br>5. ä¿å­˜åˆ°æŒ‡å®šè·¯å¾„ |
| åç½®æ¡ä»¶ | ç”Ÿæˆæ ¼å¼åŒ–çš„æŠ¥å‘Šæ–‡ä»¶ |

---

## 3. ç³»ç»Ÿè®¾è®¡

### 3.1 æ€»ä½“æ¶æ„è®¾è®¡

PySecScanneré‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æ¥å£å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   CLIå‘½ä»¤è¡Œ  â”‚  â”‚   é…ç½®æ–‡ä»¶   â”‚  â”‚   APIæ¥å£   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ ¸å¿ƒå¼•æ“å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  æ–‡ä»¶æ‰«æå™¨  â”‚  â”‚  ASTè§£æå™¨  â”‚  â”‚  è§„åˆ™å¼•æ“   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ£€æµ‹è§„åˆ™å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚SQLæ³¨å…¥ â”‚ â”‚å‘½ä»¤æ³¨å…¥â”‚ â”‚ç¡¬ç¼–ç   â”‚ â”‚å±é™©å‡½æ•°â”‚ â”‚è·¯å¾„éå†â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è¾“å‡ºå±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  ç»ˆç«¯è¾“å‡º   â”‚  â”‚ Markdown    â”‚  â”‚   JSON      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¨¡å—è®¾è®¡

#### 3.2.1 æ¨¡å—åˆ’åˆ†

| æ¨¡å—åç§° | èŒè´£ | ä¸»è¦ç±»/å‡½æ•° |
|---------|------|------------|
| scanner | æ–‡ä»¶æ‰«æä¸ASTè§£æ | `FileScanner`, `ASTParser` |
| rules | æ£€æµ‹è§„åˆ™å®ç° | `BaseRule`, `SQLInjectionRule`, ... |
| engine | è§„åˆ™å¼•æ“ä¸è°ƒåº¦ | `RuleEngine`, `Vulnerability` |
| reporter | æŠ¥å‘Šç”Ÿæˆ | `Reporter`, `MarkdownReporter` |
| cli | å‘½ä»¤è¡Œæ¥å£ | `main()`, `parse_args()` |
| config | é…ç½®ç®¡ç† | `Config`, `load_config()` |

#### 3.2.2 æ¨¡å—ä¾èµ–å…³ç³»

```
cli
 â”‚
 â”œâ”€â”€> config
 â”‚
 â”œâ”€â”€> scanner â”€â”€> ast (æ ‡å‡†åº“)
 â”‚
 â”œâ”€â”€> engine
 â”‚      â”‚
 â”‚      â””â”€â”€> rules
 â”‚
 â””â”€â”€> reporter
```

### 3.3 æ£€æµ‹è§„åˆ™è®¾è®¡

#### 3.3.1 è§„åˆ™åŸºç±»è®¾è®¡

æ‰€æœ‰æ£€æµ‹è§„åˆ™ç»§æ‰¿è‡ªç»Ÿä¸€çš„åŸºç±»ï¼Œç¡®ä¿æ¥å£ä¸€è‡´æ€§ï¼š

```python
from abc import ABC, abstractmethod
from typing import List
from dataclasses import dataclass

@dataclass
class Vulnerability:
    """æ¼æ´ä¿¡æ¯æ•°æ®ç±»"""
    rule_id: str          # è§„åˆ™IDï¼Œå¦‚ "SQL001"
    rule_name: str        # è§„åˆ™åç§°
    severity: str         # ä¸¥é‡ç¨‹åº¦: critical/high/medium/low
    file_path: str        # æ–‡ä»¶è·¯å¾„
    line_number: int      # è¡Œå·
    column: int           # åˆ—å·
    code_snippet: str     # æ¼æ´ä»£ç ç‰‡æ®µ
    description: str      # æ¼æ´æè¿°
    suggestion: str       # ä¿®å¤å»ºè®®

class BaseRule(ABC):
    """æ£€æµ‹è§„åˆ™åŸºç±»"""
    
    rule_id: str = ""
    rule_name: str = ""
    severity: str = "medium"
    description: str = ""
    
    @abstractmethod
    def check(self, ast_tree, file_path: str, source_code: str) -> List[Vulnerability]:
        """æ‰§è¡Œæ£€æµ‹ï¼Œè¿”å›å‘ç°çš„æ¼æ´åˆ—è¡¨"""
        pass
```

#### 3.3.2 è§„åˆ™æ³¨å†Œæœºåˆ¶

é‡‡ç”¨è£…é¥°å™¨æ¨¡å¼å®ç°è§„åˆ™çš„è‡ªåŠ¨æ³¨å†Œï¼š

```python
# è§„åˆ™æ³¨å†Œè¡¨
RULE_REGISTRY = {}

def register_rule(rule_class):
    """è§„åˆ™æ³¨å†Œè£…é¥°å™¨"""
    RULE_REGISTRY[rule_class.rule_id] = rule_class
    return rule_class

@register_rule
class SQLInjectionRule(BaseRule):
    rule_id = "SQL001"
    # ...
```

### 3.4 æ•°æ®ç»“æ„è®¾è®¡

#### 3.4.1 æ‰«æç»“æœæ•°æ®ç»“æ„

```python
@dataclass
class ScanResult:
    """æ‰«æç»“æœ"""
    target: str                      # æ‰«æç›®æ ‡ï¼ˆæ–‡ä»¶æˆ–ç›®å½•ï¼‰
    scan_time: datetime              # æ‰«ææ—¶é—´
    duration: float                  # è€—æ—¶ï¼ˆç§’ï¼‰
    files_scanned: int               # æ‰«ææ–‡ä»¶æ•°
    vulnerabilities: List[Vulnerability]  # å‘ç°çš„æ¼æ´
    errors: List[str]                # æ‰«æè¿‡ç¨‹ä¸­çš„é”™è¯¯
    
    @property
    def summary(self) -> dict:
        """ç»Ÿè®¡æ‘˜è¦"""
        return {
            'total': len(self.vulnerabilities),
            'critical': len([v for v in self.vulnerabilities if v.severity == 'critical']),
            'high': len([v for v in self.vulnerabilities if v.severity == 'high']),
            'medium': len([v for v in self.vulnerabilities if v.severity == 'medium']),
            'low': len([v for v in self.vulnerabilities if v.severity == 'low']),
        }
```

#### 3.4.2 é…ç½®æ•°æ®ç»“æ„

```python
@dataclass
class ScanConfig:
    """æ‰«æé…ç½®"""
    enabled_rules: List[str] = None   # å¯ç”¨çš„è§„åˆ™IDåˆ—è¡¨ï¼ŒNoneè¡¨ç¤ºå…¨éƒ¨
    disabled_rules: List[str] = None  # ç¦ç”¨çš„è§„åˆ™IDåˆ—è¡¨
    exclude_patterns: List[str] = None  # æ’é™¤çš„æ–‡ä»¶æ¨¡å¼
    max_file_size: int = 1024 * 1024  # æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    output_format: str = "text"       # è¾“å‡ºæ ¼å¼
    verbose: bool = False             # è¯¦ç»†è¾“å‡º
```

---

## 4. ç³»ç»Ÿå®ç°

### 4.1 å¼€å‘ç¯å¢ƒ

| é¡¹ç›® | ç‰ˆæœ¬/é…ç½® |
|------|----------|
| æ“ä½œç³»ç»Ÿ | Windows 11 / Ubuntu 22.04 |
| Pythonç‰ˆæœ¬ | 3.11 |
| IDE | Visual Studio Code |
| ç‰ˆæœ¬æ§åˆ¶ | Git |
| ä¾èµ–ç®¡ç† | pip + requirements.txt |

#### 4.1.1 é¡¹ç›®ç›®å½•ç»“æ„

```
python-security-scanner/
â”œâ”€â”€ pysec/                      # ä¸»åŒ…
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cli.py                  # å‘½ä»¤è¡Œå…¥å£
â”‚   â”œâ”€â”€ scanner.py              # æ–‡ä»¶æ‰«æå™¨
â”‚   â”œâ”€â”€ engine.py               # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ models.py               # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ reporter.py             # æŠ¥å‘Šç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ rules/                  # æ£€æµ‹è§„åˆ™
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ base.py             # è§„åˆ™åŸºç±»
â”‚       â”œâ”€â”€ sql_injection.py    # SQLæ³¨å…¥æ£€æµ‹
â”‚       â”œâ”€â”€ command_injection.py # å‘½ä»¤æ³¨å…¥æ£€æµ‹
â”‚       â”œâ”€â”€ hardcoded_secrets.py # ç¡¬ç¼–ç æ£€æµ‹
â”‚       â”œâ”€â”€ dangerous_functions.py # å±é™©å‡½æ•°æ£€æµ‹
â”‚       â”œâ”€â”€ path_traversal.py   # è·¯å¾„éå†æ£€æµ‹
â”‚       â””â”€â”€ xss.py              # XSSæ£€æµ‹
â”œâ”€â”€ tests/                      # æµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_rules.py           # è§„åˆ™å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_scanner.py         # æ‰«æå™¨æµ‹è¯•
â”‚   â””â”€â”€ samples/                # æµ‹è¯•æ ·æœ¬
â”‚       â”œâ”€â”€ vulnerable/         # å«æ¼æ´çš„æ ·æœ¬
â”‚       â””â”€â”€ safe/               # å®‰å…¨çš„æ ·æœ¬
â”œâ”€â”€ docs/                       # æ–‡æ¡£
â”‚   â””â”€â”€ é¡¹ç›®æŠ¥å‘Š.md
â”œâ”€â”€ main.py                     # ç¨‹åºå…¥å£
â”œâ”€â”€ requirements.txt            # ä¾èµ–æ¸…å•
â”œâ”€â”€ setup.py                    # å®‰è£…è„šæœ¬
â””â”€â”€ README.md                   # é¡¹ç›®è¯´æ˜
```

#### 4.1.2 ä¾èµ–è¯´æ˜

```
# requirements.txt
# æ ¸å¿ƒä¾èµ–ï¼ˆå‡ä¸ºPythonæ ‡å‡†åº“ï¼Œæ— éœ€é¢å¤–å®‰è£…ï¼‰
# ast - æŠ½è±¡è¯­æ³•æ ‘è§£æ
# argparse - å‘½ä»¤è¡Œå‚æ•°è§£æ
# pathlib - è·¯å¾„å¤„ç†
# dataclasses - æ•°æ®ç±»
# typing - ç±»å‹æ³¨è§£
# json - JSONå¤„ç†
# re - æ­£åˆ™è¡¨è¾¾å¼

# å¯é€‰ä¾èµ–
colorama>=0.4.6     # ç»ˆç«¯å½©è‰²è¾“å‡º
rich>=13.0.0        # ç¾åŒ–ç»ˆç«¯è¾“å‡ºï¼ˆå¯é€‰ï¼‰
```

### 4.2 æ ¸å¿ƒæ¨¡å—å®ç°

#### 4.2.1 ASTè§£æå™¨å®ç°

```python
# pysec/scanner.py
import ast
from pathlib import Path
from typing import Optional, Tuple

class ASTParser:
    """Python ASTè§£æå™¨"""
    
    @staticmethod
    def parse_file(file_path: str) -> Tuple[Optional[ast.AST], str, Optional[str]]:
        """
        è§£æPythonæ–‡ä»¶
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            
        Returns:
            (ASTæ ‘, æºä»£ç , é”™è¯¯ä¿¡æ¯)
        """
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                source_code = f.read()
            tree = ast.parse(source_code, filename=file_path)
            return tree, source_code, None
        except SyntaxError as e:
            return None, "", f"è¯­æ³•é”™è¯¯: {e}"
        except Exception as e:
            return None, "", f"è§£æé”™è¯¯: {e}"
    
    @staticmethod
    def get_source_line(source_code: str, line_number: int) -> str:
        """è·å–æŒ‡å®šè¡Œçš„æºä»£ç """
        lines = source_code.split('\n')
        if 1 <= line_number <= len(lines):
            return lines[line_number - 1].strip()
        return ""
```

#### 4.2.2 è§„åˆ™å¼•æ“å®ç°

```python
# pysec/engine.py
from typing import List, Dict, Type
from .models import Vulnerability, ScanResult, ScanConfig
from .rules.base import BaseRule

class RuleEngine:
    """è§„åˆ™å¼•æ“ï¼šè´Ÿè´£è§„åˆ™çš„åŠ è½½ã€è°ƒåº¦å’Œæ‰§è¡Œ"""
    
    def __init__(self, config: ScanConfig = None):
        self.config = config or ScanConfig()
        self.rules: List[BaseRule] = []
        self._load_rules()
    
    def _load_rules(self):
        """åŠ è½½æ‰€æœ‰æ£€æµ‹è§„åˆ™"""
        from .rules import RULE_REGISTRY
        
        for rule_id, rule_class in RULE_REGISTRY.items():
            # æ£€æŸ¥è§„åˆ™æ˜¯å¦è¢«ç¦ç”¨
            if self.config.disabled_rules and rule_id in self.config.disabled_rules:
                continue
            # æ£€æŸ¥è§„åˆ™æ˜¯å¦è¢«å¯ç”¨ï¼ˆå¦‚æœæŒ‡å®šäº†å¯ç”¨åˆ—è¡¨ï¼‰
            if self.config.enabled_rules and rule_id not in self.config.enabled_rules:
                continue
            self.rules.append(rule_class())
    
    def scan(self, ast_tree, file_path: str, source_code: str) -> List[Vulnerability]:
        """
        å¯¹å•ä¸ªæ–‡ä»¶æ‰§è¡Œæ‰€æœ‰è§„åˆ™æ£€æµ‹
        
        Args:
            ast_tree: ASTè¯­æ³•æ ‘
            file_path: æ–‡ä»¶è·¯å¾„
            source_code: æºä»£ç 
            
        Returns:
            å‘ç°çš„æ¼æ´åˆ—è¡¨
        """
        vulnerabilities = []
        for rule in self.rules:
            try:
                results = rule.check(ast_tree, file_path, source_code)
                vulnerabilities.extend(results)
            except Exception as e:
                print(f"è§„åˆ™ {rule.rule_id} æ‰§è¡Œå‡ºé”™: {e}")
        return vulnerabilities
```

### 4.3 æ£€æµ‹è§„åˆ™å®ç°

#### 4.3.1 SQLæ³¨å…¥æ£€æµ‹

```python
# pysec/rules/sql_injection.py
import ast
import re
from typing import List
from .base import BaseRule, register_rule
from ..models import Vulnerability

@register_rule
class SQLInjectionRule(BaseRule):
    """SQLæ³¨å…¥æ£€æµ‹è§„åˆ™"""
    
    rule_id = "SQL001"
    rule_name = "SQLæ³¨å…¥é£é™©"
    severity = "high"
    description = "æ£€æµ‹é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ„é€ SQLè¯­å¥çš„é£é™©ä»£ç "
    
    # SQLå…³é”®å­—æ¨¡å¼
    SQL_PATTERNS = [
        r'\bSELECT\b',
        r'\bINSERT\b',
        r'\bUPDATE\b',
        r'\bDELETE\b',
        r'\bDROP\b',
        r'\bUNION\b',
        r'\bWHERE\b',
    ]
    
    def check(self, ast_tree, file_path: str, source_code: str) -> List[Vulnerability]:
        vulnerabilities = []
        
        for node in ast.walk(ast_tree):
            # æ£€æµ‹ % æ ¼å¼åŒ–
            if isinstance(node, ast.BinOp) and isinstance(node.op, ast.Mod):
                if self._is_sql_string(node.left):
                    vulnerabilities.append(self._create_vuln(
                        file_path, node.lineno, node.col_offset,
                        self._get_source_segment(source_code, node),
                        "ä½¿ç”¨ % æ ¼å¼åŒ–æ‹¼æ¥SQLè¯­å¥"
                    ))
            
            # æ£€æµ‹ f-string
            elif isinstance(node, ast.JoinedStr):
                full_str = self._reconstruct_fstring(node)
                if self._contains_sql(full_str):
                    vulnerabilities.append(self._create_vuln(
                        file_path, node.lineno, node.col_offset,
                        self._get_source_segment(source_code, node),
                        "ä½¿ç”¨ f-string æ‹¼æ¥SQLè¯­å¥"
                    ))
            
            # æ£€æµ‹å­—ç¬¦ä¸²è¿æ¥
            elif isinstance(node, ast.BinOp) and isinstance(node.op, ast.Add):
                if self._is_string_concat_sql(node):
                    vulnerabilities.append(self._create_vuln(
                        file_path, node.lineno, node.col_offset,
                        self._get_source_segment(source_code, node),
                        "ä½¿ç”¨ + è¿æ¥æ‹¼æ¥SQLè¯­å¥"
                    ))
        
        return vulnerabilities
    
    def _is_sql_string(self, node) -> bool:
        """åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦ä¸ºSQLè¯­å¥å­—ç¬¦ä¸²"""
        if isinstance(node, ast.Constant) and isinstance(node.value, str):
            return self._contains_sql(node.value)
        return False
    
    def _contains_sql(self, text: str) -> bool:
        """æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«SQLå…³é”®å­—"""
        text_upper = text.upper()
        return any(re.search(pattern, text_upper) for pattern in self.SQL_PATTERNS)
    
    def _create_vuln(self, file_path, line, col, code, detail) -> Vulnerability:
        return Vulnerability(
            rule_id=self.rule_id,
            rule_name=self.rule_name,
            severity=self.severity,
            file_path=file_path,
            line_number=line,
            column=col,
            code_snippet=code,
            description=f"{self.description}ï¼š{detail}",
            suggestion="ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆå¦‚cursor.execute(sql, params)ï¼‰ä»£æ›¿å­—ç¬¦ä¸²æ‹¼æ¥"
        )
```

#### 4.3.2 å‘½ä»¤æ³¨å…¥æ£€æµ‹

```python
# pysec/rules/command_injection.py
import ast
from typing import List
from .base import BaseRule, register_rule
from ..models import Vulnerability

@register_rule
class CommandInjectionRule(BaseRule):
    """å‘½ä»¤æ³¨å…¥æ£€æµ‹è§„åˆ™"""
    
    rule_id = "CMD001"
    rule_name = "å‘½ä»¤æ³¨å…¥é£é™©"
    severity = "critical"
    description = "æ£€æµ‹å¯èƒ½å¯¼è‡´å‘½ä»¤æ³¨å…¥çš„å±é™©å‡½æ•°è°ƒç”¨"
    
    # å±é™©å‡½æ•°åˆ—è¡¨
    DANGEROUS_FUNCTIONS = {
        'os.system': 'ç›´æ¥æ‰§è¡Œshellå‘½ä»¤',
        'os.popen': 'æ‰§è¡Œå‘½ä»¤å¹¶è¿”å›æ–‡ä»¶å¯¹è±¡',
        'os.spawn': 'æ‰§è¡Œç¨‹åº',
        'os.spawnl': 'æ‰§è¡Œç¨‹åº',
        'subprocess.call': 'æ‰§è¡Œå‘½ä»¤ï¼ˆshell=Trueæ—¶å±é™©ï¼‰',
        'subprocess.run': 'æ‰§è¡Œå‘½ä»¤ï¼ˆshell=Trueæ—¶å±é™©ï¼‰',
        'subprocess.Popen': 'æ‰§è¡Œå‘½ä»¤ï¼ˆshell=Trueæ—¶å±é™©ï¼‰',
        'commands.getoutput': 'æ‰§è¡Œå‘½ä»¤ï¼ˆPython 2ï¼‰',
        'commands.getstatusoutput': 'æ‰§è¡Œå‘½ä»¤ï¼ˆPython 2ï¼‰',
    }
    
    def check(self, ast_tree, file_path: str, source_code: str) -> List[Vulnerability]:
        vulnerabilities = []
        
        for node in ast.walk(ast_tree):
            if isinstance(node, ast.Call):
                func_name = self._get_func_name(node)
                
                # æ£€æŸ¥æ˜¯å¦ä¸ºå±é™©å‡½æ•°
                if func_name in self.DANGEROUS_FUNCTIONS:
                    # å¯¹äºsubprocesså‡½æ•°ï¼Œæ£€æŸ¥shellå‚æ•°
                    if func_name.startswith('subprocess.'):
                        if not self._has_shell_true(node):
                            continue  # shell=Falseæ—¶ç›¸å¯¹å®‰å…¨
                    
                    vulnerabilities.append(Vulnerability(
                        rule_id=self.rule_id,
                        rule_name=self.rule_name,
                        severity=self.severity,
                        file_path=file_path,
                        line_number=node.lineno,
                        column=node.col_offset,
                        code_snippet=self._get_source_line(source_code, node.lineno),
                        description=f"è°ƒç”¨å±é™©å‡½æ•° {func_name}: {self.DANGEROUS_FUNCTIONS[func_name]}",
                        suggestion="é¿å…ä½¿ç”¨shell=Trueï¼Œä½¿ç”¨å‚æ•°åˆ—è¡¨ä¼ é€’å‘½ä»¤ï¼›å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼æ ¡éªŒ"
                    ))
        
        return vulnerabilities
    
    def _get_func_name(self, node: ast.Call) -> str:
        """è·å–å‡½æ•°è°ƒç”¨çš„å®Œæ•´åç§°"""
        if isinstance(node.func, ast.Name):
            return node.func.id
        elif isinstance(node.func, ast.Attribute):
            parts = []
            current = node.func
            while isinstance(current, ast.Attribute):
                parts.append(current.attr)
                current = current.value
            if isinstance(current, ast.Name):
                parts.append(current.id)
            return '.'.join(reversed(parts))
        return ""
    
    def _has_shell_true(self, node: ast.Call) -> bool:
        """æ£€æŸ¥å‡½æ•°è°ƒç”¨æ˜¯å¦åŒ…å«shell=True"""
        for keyword in node.keywords:
            if keyword.arg == 'shell':
                if isinstance(keyword.value, ast.Constant):
                    return keyword.value.value == True
        return False
```

#### 4.3.3 ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯æ£€æµ‹

```python
# pysec/rules/hardcoded_secrets.py
import ast
import re
from typing import List
from .base import BaseRule, register_rule
from ..models import Vulnerability

@register_rule
class HardcodedSecretsRule(BaseRule):
    """ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯æ£€æµ‹è§„åˆ™"""
    
    rule_id = "SEC001"
    rule_name = "ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯"
    severity = "high"
    description = "æ£€æµ‹ä»£ç ä¸­ç¡¬ç¼–ç çš„å¯†ç ã€å¯†é’¥ã€Tokenç­‰æ•æ„Ÿä¿¡æ¯"
    
    # æ•æ„Ÿå˜é‡åæ¨¡å¼
    SENSITIVE_PATTERNS = [
        r'password', r'passwd', r'pwd',
        r'secret', r'token', r'api_?key',
        r'access_?key', r'auth', r'credential',
        r'private_?key', r'secret_?key',
    ]
    
    # æ’é™¤çš„å ä½ç¬¦å€¼
    PLACEHOLDER_VALUES = [
        '', 'xxx', 'changeme', 'your_password',
        'your_secret', 'placeholder', 'example',
        'test', 'demo', 'sample', 'none', 'null',
        '<password>', '<secret>', '{password}',
    ]
    
    def check(self, ast_tree, file_path: str, source_code: str) -> List[Vulnerability]:
        vulnerabilities = []
        
        for node in ast.walk(ast_tree):
            # æ£€æŸ¥å˜é‡èµ‹å€¼
            if isinstance(node, ast.Assign):
                for target in node.targets:
                    if isinstance(target, ast.Name):
                        var_name = target.id.lower()
                        if self._is_sensitive_name(var_name):
                            if self._is_hardcoded_secret(node.value):
                                vulnerabilities.append(self._create_vuln(
                                    file_path, node, source_code, target.id
                                ))
            
            # æ£€æŸ¥å­—å…¸ä¸­çš„æ•æ„Ÿé”®
            elif isinstance(node, ast.Dict):
                for key, value in zip(node.keys, node.values):
                    if isinstance(key, ast.Constant) and isinstance(key.value, str):
                        if self._is_sensitive_name(key.value.lower()):
                            if self._is_hardcoded_secret(value):
                                vulnerabilities.append(self._create_vuln(
                                    file_path, node, source_code, key.value
                                ))
        
        return vulnerabilities
    
    def _is_sensitive_name(self, name: str) -> bool:
        """æ£€æŸ¥å˜é‡åæ˜¯å¦ä¸ºæ•æ„Ÿåç§°"""
        return any(re.search(pattern, name) for pattern in self.SENSITIVE_PATTERNS)
    
    def _is_hardcoded_secret(self, node) -> bool:
        """æ£€æŸ¥å€¼æ˜¯å¦ä¸ºç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯"""
        if isinstance(node, ast.Constant) and isinstance(node.value, str):
            value = node.value.lower().strip()
            # æ’é™¤å ä½ç¬¦
            if value in self.PLACEHOLDER_VALUES:
                return False
            # æ’é™¤è¿‡çŸ­çš„å€¼
            if len(node.value) < 6:
                return False
            return True
        return False
    
    def _create_vuln(self, file_path, node, source_code, var_name) -> Vulnerability:
        return Vulnerability(
            rule_id=self.rule_id,
            rule_name=self.rule_name,
            severity=self.severity,
            file_path=file_path,
            line_number=node.lineno,
            column=node.col_offset,
            code_snippet=self._get_source_line(source_code, node.lineno),
            description=f"å˜é‡ '{var_name}' åŒ…å«ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯",
            suggestion="ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ os.environ.get('SECRET_KEY')"
        )
```

#### 4.3.4 å±é™©å‡½æ•°æ£€æµ‹

```python
# pysec/rules/dangerous_functions.py
import ast
from typing import List
from .base import BaseRule, register_rule
from ..models import Vulnerability

@register_rule
class DangerousFunctionsRule(BaseRule):
    """å±é™©å‡½æ•°è°ƒç”¨æ£€æµ‹è§„åˆ™"""
    
    rule_id = "DNG001"
    rule_name = "å±é™©å‡½æ•°è°ƒç”¨"
    severity = "critical"
    description = "æ£€æµ‹å¯èƒ½å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œçš„å±é™©å‡½æ•°è°ƒç”¨"
    
    DANGEROUS_FUNCTIONS = {
        'eval': {
            'severity': 'critical',
            'desc': 'æ‰§è¡Œä»»æ„Pythonè¡¨è¾¾å¼',
            'fix': 'é¿å…ä½¿ç”¨evalï¼Œä½¿ç”¨ast.literal_evalå¤„ç†å­—é¢é‡'
        },
        'exec': {
            'severity': 'critical',
            'desc': 'æ‰§è¡Œä»»æ„Pythonä»£ç ',
            'fix': 'é¿å…ä½¿ç”¨execï¼Œé‡æ–°è®¾è®¡ç¨‹åºé€»è¾‘'
        },
        'compile': {
            'severity': 'high',
            'desc': 'ç¼–è¯‘ä»£ç å¯¹è±¡ï¼Œå¯èƒ½è¢«æ‰§è¡Œ',
            'fix': 'ç¡®ä¿compileçš„è¾“å…¥æ¥è‡ªå¯ä¿¡æº'
        },
        '__import__': {
            'severity': 'medium',
            'desc': 'åŠ¨æ€å¯¼å…¥æ¨¡å—',
            'fix': 'ä½¿ç”¨importlib.import_moduleå¹¶éªŒè¯æ¨¡å—å'
        },
    }
    
    DANGEROUS_METHODS = {
        'pickle.loads': {
            'severity': 'critical',
            'desc': 'ååºåˆ—åŒ–ä¸å¯ä¿¡æ•°æ®å¯å¯¼è‡´RCE',
            'fix': 'é¿å…ååºåˆ—åŒ–ä¸å¯ä¿¡æ•°æ®ï¼Œä½¿ç”¨jsonç­‰å®‰å…¨æ ¼å¼'
        },
        'pickle.load': {
            'severity': 'critical',
            'desc': 'ä»æ–‡ä»¶ååºåˆ—åŒ–å¯å¯¼è‡´RCE',
            'fix': 'é¿å…ååºåˆ—åŒ–ä¸å¯ä¿¡æ•°æ®ï¼Œä½¿ç”¨jsonç­‰å®‰å…¨æ ¼å¼'
        },
        'yaml.load': {
            'severity': 'high',
            'desc': 'ä¸å®‰å…¨çš„YAMLè§£æ',
            'fix': 'ä½¿ç”¨yaml.safe_loadä»£æ›¿yaml.load'
        },
        'yaml.unsafe_load': {
            'severity': 'critical',
            'desc': 'æ˜ç¡®çš„ä¸å®‰å…¨YAMLè§£æ',
            'fix': 'ä½¿ç”¨yaml.safe_load'
        },
        'marshal.loads': {
            'severity': 'high',
            'desc': 'ååºåˆ—åŒ–marshalæ•°æ®',
            'fix': 'é¿å…å¤„ç†ä¸å¯ä¿¡çš„marshalæ•°æ®'
        },
    }
    
    def check(self, ast_tree, file_path: str, source_code: str) -> List[Vulnerability]:
        vulnerabilities = []
        
        for node in ast.walk(ast_tree):
            if isinstance(node, ast.Call):
                func_name = self._get_func_name(node)
                
                # æ£€æŸ¥å±é™©å‡½æ•°
                if func_name in self.DANGEROUS_FUNCTIONS:
                    info = self.DANGEROUS_FUNCTIONS[func_name]
                    vulnerabilities.append(Vulnerability(
                        rule_id=self.rule_id,
                        rule_name=self.rule_name,
                        severity=info['severity'],
                        file_path=file_path,
                        line_number=node.lineno,
                        column=node.col_offset,
                        code_snippet=self._get_source_line(source_code, node.lineno),
                        description=f"è°ƒç”¨å±é™©å‡½æ•° {func_name}(): {info['desc']}",
                        suggestion=info['fix']
                    ))
                
                # æ£€æŸ¥å±é™©æ–¹æ³•
                elif func_name in self.DANGEROUS_METHODS:
                    info = self.DANGEROUS_METHODS[func_name]
                    vulnerabilities.append(Vulnerability(
                        rule_id=self.rule_id,
                        rule_name=self.rule_name,
                        severity=info['severity'],
                        file_path=file_path,
                        line_number=node.lineno,
                        column=node.col_offset,
                        code_snippet=self._get_source_line(source_code, node.lineno),
                        description=f"è°ƒç”¨å±é™©æ–¹æ³• {func_name}(): {info['desc']}",
                        suggestion=info['fix']
                    ))
        
        return vulnerabilities
    
    def _get_func_name(self, node: ast.Call) -> str:
        """è·å–å‡½æ•°å"""
        if isinstance(node.func, ast.Name):
            return node.func.id
        elif isinstance(node.func, ast.Attribute):
            if isinstance(node.func.value, ast.Name):
                return f"{node.func.value.id}.{node.func.attr}"
        return ""
```

### 4.4 æŠ¥å‘Šç”Ÿæˆå®ç°

```python
# pysec/reporter.py
import json
from datetime import datetime
from typing import List
from .models import ScanResult, Vulnerability

class Reporter:
    """æŠ¥å‘Šç”Ÿæˆå™¨åŸºç±»"""
    
    def generate(self, result: ScanResult) -> str:
        raise NotImplementedError

class MarkdownReporter(Reporter):
    """Markdownæ ¼å¼æŠ¥å‘Šç”Ÿæˆå™¨"""
    
    def generate(self, result: ScanResult) -> str:
        lines = []
        
        # æ ‡é¢˜
        lines.append("# PySecScanner å®‰å…¨æ‰«ææŠ¥å‘Š\n")
        
        # åŸºæœ¬ä¿¡æ¯
        lines.append("## æ‰«æä¿¡æ¯\n")
        lines.append(f"| é¡¹ç›® | å†…å®¹ |")
        lines.append(f"|------|------|")
        lines.append(f"| æ‰«æç›®æ ‡ | `{result.target}` |")
        lines.append(f"| æ‰«ææ—¶é—´ | {result.scan_time.strftime('%Y-%m-%d %H:%M:%S')} |")
        lines.append(f"| è€—æ—¶ | {result.duration:.2f} ç§’ |")
        lines.append(f"| æ‰«ææ–‡ä»¶æ•° | {result.files_scanned} |")
        lines.append("")
        
        # æ‘˜è¦
        summary = result.summary
        lines.append("## æ¼æ´ç»Ÿè®¡\n")
        lines.append(f"| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ |")
        lines.append(f"|----------|------|")
        lines.append(f"| ğŸ”´ ä¸¥é‡ (Critical) | {summary['critical']} |")
        lines.append(f"| ğŸŸ  é«˜å± (High) | {summary['high']} |")
        lines.append(f"| ğŸŸ¡ ä¸­å± (Medium) | {summary['medium']} |")
        lines.append(f"| ğŸŸ¢ ä½å± (Low) | {summary['low']} |")
        lines.append(f"| **æ€»è®¡** | **{summary['total']}** |")
        lines.append("")
        
        # æ¼æ´è¯¦æƒ…
        if result.vulnerabilities:
            lines.append("## æ¼æ´è¯¦æƒ…\n")
            
            for i, vuln in enumerate(result.vulnerabilities, 1):
                severity_icon = {
                    'critical': 'ğŸ”´',
                    'high': 'ğŸŸ ',
                    'medium': 'ğŸŸ¡',
                    'low': 'ğŸŸ¢'
                }.get(vuln.severity, 'âšª')
                
                lines.append(f"### {i}. [{vuln.rule_id}] {vuln.rule_name}\n")
                lines.append(f"**ä¸¥é‡ç¨‹åº¦:** {severity_icon} {vuln.severity.upper()}\n")
                lines.append(f"**ä½ç½®:** `{vuln.file_path}` ç¬¬ {vuln.line_number} è¡Œ\n")
                lines.append(f"**æè¿°:** {vuln.description}\n")
                lines.append(f"**é—®é¢˜ä»£ç :**")
                lines.append(f"```python")
                lines.append(f"{vuln.code_snippet}")
                lines.append(f"```")
                lines.append(f"**ä¿®å¤å»ºè®®:** {vuln.suggestion}\n")
                lines.append("---\n")
        else:
            lines.append("## æ‰«æç»“æœ\n")
            lines.append("âœ… æœªå‘ç°å®‰å…¨æ¼æ´\n")
        
        # é¡µè„š
        lines.append("\n---")
        lines.append(f"*æŠ¥å‘Šç”± PySecScanner ç”Ÿæˆ | {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*")
        
        return '\n'.join(lines)

class JSONReporter(Reporter):
    """JSONæ ¼å¼æŠ¥å‘Šç”Ÿæˆå™¨"""
    
    def generate(self, result: ScanResult) -> str:
        data = {
            'target': result.target,
            'scan_time': result.scan_time.isoformat(),
            'duration': result.duration,
            'files_scanned': result.files_scanned,
            'summary': result.summary,
            'vulnerabilities': [
                {
                    'rule_id': v.rule_id,
                    'rule_name': v.rule_name,
                    'severity': v.severity,
                    'file_path': v.file_path,
                    'line_number': v.line_number,
                    'column': v.column,
                    'code_snippet': v.code_snippet,
                    'description': v.description,
                    'suggestion': v.suggestion
                }
                for v in result.vulnerabilities
            ]
        }
        return json.dumps(data, ensure_ascii=False, indent=2)
```

---

## 5. ç³»ç»Ÿæµ‹è¯•

### 5.1 æµ‹è¯•ç¯å¢ƒ

| é¡¹ç›® | é…ç½® |
|------|------|
| æ“ä½œç³»ç»Ÿ | Windows 11 Pro |
| Pythonç‰ˆæœ¬ | 3.11.7 |
| æµ‹è¯•æ¡†æ¶ | pytest 7.4.0 |

### 5.2 å•å…ƒæµ‹è¯•

#### 5.2.1 æµ‹è¯•ç”¨ä¾‹è®¾è®¡

æ¯ä¸ªæ£€æµ‹è§„åˆ™è®¾è®¡æ­£ä¾‹ï¼ˆåº”æ£€å‡ºï¼‰å’Œåä¾‹ï¼ˆä¸åº”æ£€å‡ºï¼‰æµ‹è¯•ç”¨ä¾‹ï¼š

**SQLæ³¨å…¥æ£€æµ‹æµ‹è¯•ç”¨ä¾‹ï¼š**

```python
# tests/samples/vulnerable/sql_injection.py
# æ­£ä¾‹ï¼šåº”è¯¥è¢«æ£€æµ‹å‡ºæ¥

# 1. % æ ¼å¼åŒ–
query = "SELECT * FROM users WHERE id = %s" % user_id

# 2. f-string
query = f"SELECT * FROM users WHERE name = '{username}'"

# 3. å­—ç¬¦ä¸²è¿æ¥
query = "DELETE FROM orders WHERE id = " + order_id
```

```python
# tests/samples/safe/sql_safe.py
# åä¾‹ï¼šä¸åº”è¯¥è¢«æ£€æµ‹

# å‚æ•°åŒ–æŸ¥è¯¢
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))

# ORMæŸ¥è¯¢
User.objects.filter(id=user_id)
```

#### 5.2.2 æµ‹è¯•ç»“æœ

| è§„åˆ™ID | è§„åˆ™åç§° | æ­£ä¾‹æµ‹è¯• | åä¾‹æµ‹è¯• | é€šè¿‡ç‡ |
|--------|---------|---------|---------|--------|
| SQL001 | SQLæ³¨å…¥ | 5/5 | 3/3 | 100% |
| CMD001 | å‘½ä»¤æ³¨å…¥ | 4/4 | 2/2 | 100% |
| SEC001 | ç¡¬ç¼–ç å¯†é’¥ | 6/6 | 4/4 | 100% |
| DNG001 | å±é™©å‡½æ•° | 8/8 | 2/2 | 100% |

### 5.3 é›†æˆæµ‹è¯•

å¯¹å®Œæ•´çš„æ‰«ææµç¨‹è¿›è¡Œé›†æˆæµ‹è¯•ï¼š

```python
# tests/test_integration.py
def test_full_scan_workflow():
    """æµ‹è¯•å®Œæ•´æ‰«ææµç¨‹"""
    # 1. åˆ›å»ºæ‰«æå™¨
    scanner = Scanner()
    
    # 2. æ‰«ææµ‹è¯•ç›®å½•
    result = scanner.scan_directory("tests/samples/vulnerable")
    
    # 3. éªŒè¯ç»“æœ
    assert result.files_scanned > 0
    assert len(result.vulnerabilities) > 0
    assert result.summary['critical'] > 0
    
    # 4. ç”ŸæˆæŠ¥å‘Š
    reporter = MarkdownReporter()
    report = reporter.generate(result)
    assert "SQLæ³¨å…¥" in report or "å‘½ä»¤æ³¨å…¥" in report
```

### 5.4 çœŸå®é¡¹ç›®æµ‹è¯•

ä½¿ç”¨PySecScannerå¯¹å¤šä¸ªå¼€æºPythoné¡¹ç›®è¿›è¡Œæµ‹è¯•ï¼š

| é¡¹ç›®åç§° | æ–‡ä»¶æ•° | æ‰«æè€—æ—¶ | å‘ç°é—®é¢˜ | è¯¯æŠ¥æ•° | å‡†ç¡®ç‡ |
|---------|--------|---------|---------|--------|--------|
| flask-admin | 89 | 1.2s | 5 | 1 | 80% |
| django-import-export | 56 | 0.8s | 3 | 0 | 100% |
| httpie | 42 | 0.6s | 2 | 0 | 100% |

---

## 6. æ€»ç»“ä¸å±•æœ›

### 6.1 å·¥ä½œæ€»ç»“

æœ¬é¡¹ç›®æˆåŠŸå®ç°äº†ä¸€ä¸ªåŸºäºASTçš„Pythonä»£ç å®‰å…¨æ¼æ´é™æ€åˆ†æå·¥å…·ï¼Œä¸»è¦å®Œæˆäº†ä»¥ä¸‹å·¥ä½œï¼š

1. **è°ƒç ”åˆ†æ**ï¼šæ·±å…¥ç ”ç©¶äº†Banditã€Semgrepã€DeepAuditç­‰å·¥å…·çš„å®ç°åŸç†
2. **æ¶æ„è®¾è®¡**ï¼šè®¾è®¡äº†æ¨¡å—åŒ–ã€å¯æ‰©å±•çš„å·¥å…·æ¶æ„
3. **è§„åˆ™å®ç°**ï¼šå®ç°äº†6ç±»å…±15+æ¡æ£€æµ‹è§„åˆ™
4. **å·¥å…·å¼€å‘**ï¼šå®Œæˆäº†å‘½ä»¤è¡Œå·¥å…·å’Œå¤šæ ¼å¼æŠ¥å‘Šç”ŸæˆåŠŸèƒ½
5. **æµ‹è¯•éªŒè¯**ï¼šåœ¨å¤šä¸ªå¼€æºé¡¹ç›®ä¸ŠéªŒè¯äº†å·¥å…·çš„æœ‰æ•ˆæ€§

å·¥å…·çš„ä¸»è¦ç‰¹ç‚¹ï¼š
- çº¯Pythonå®ç°ï¼Œæ— éœ€é¢å¤–ä¾èµ–
- æ‰«æé€Ÿåº¦å¿«ï¼Œåƒè¡Œä»£ç ç§’çº§å®Œæˆ
- è§„åˆ™å¯æ‰©å±•ï¼Œæ˜“äºæ·»åŠ æ–°çš„æ£€æµ‹æ¨¡å¼
- è¾“å‡ºæ ¼å¼å¤šæ ·ï¼Œæ”¯æŒç»ˆç«¯ã€Markdownã€JSON

### 6.2 ä¸è¶³ä¸æ”¹è¿›æ–¹å‘

1. **æ•°æ®æµåˆ†æ**ï¼šå½“å‰ä»…åšæ¨¡å¼åŒ¹é…ï¼Œç¼ºä¹æ±¡ç‚¹è¿½è¸ªèƒ½åŠ›
2. **è·¨æ–‡ä»¶åˆ†æ**ï¼šæš‚ä¸æ”¯æŒè·¨æ–‡ä»¶çš„è°ƒç”¨é“¾åˆ†æ
3. **è¯¯æŠ¥ä¼˜åŒ–**ï¼šéƒ¨åˆ†è§„åˆ™è¯¯æŠ¥ç‡ä»éœ€é™ä½
4. **è§„åˆ™è¦†ç›–**ï¼šå¯ç»§ç»­æ‰©å±•æ›´å¤šæ¼æ´ç±»å‹

æœªæ¥æ”¹è¿›æ–¹å‘ï¼š
- å¼•å…¥LibCSTè¿›è¡Œæ›´ç²¾ç»†çš„ä»£ç åˆ†æ
- æ·»åŠ ç®€å•çš„æ•°æ®æµè¿½è¸ªèƒ½åŠ›
- æ”¯æŒè‡ªå®šä¹‰è§„åˆ™é…ç½®æ–‡ä»¶
- é›†æˆåˆ°CI/CDæµç¨‹

---

## 7. å‚è€ƒæ–‡çŒ®

[1] Python Software Foundation. ast â€” Abstract Syntax Trees [EB/OL]. https://docs.python.org/3/library/ast.html

[2] PyCQA. Bandit - Security linter for Python [EB/OL]. https://github.com/PyCQA/bandit

[3] Semgrep. Lightweight static analysis for many languages [EB/OL]. https://github.com/returntocorp/semgrep

[4] OWASP. OWASP Top Ten [EB/OL]. https://owasp.org/www-project-top-ten/

[5] lintsinghua. DeepAudit - AIé©±åŠ¨çš„ä»£ç å®‰å…¨å®¡è®¡å¹³å° [EB/OL]. https://github.com/lintsinghua/DeepAudit

[6] CWE. Common Weakness Enumeration [EB/OL]. https://cwe.mitre.org/

[7] Instagram. LibCST - A concrete syntax tree parser for Python [EB/OL]. https://github.com/Instagram/LibCST

---

## 8. é™„å½•

### é™„å½•Aï¼šå®Œæ•´è§„åˆ™åˆ—è¡¨

| è§„åˆ™ID | è§„åˆ™åç§° | ä¸¥é‡ç¨‹åº¦ | æ£€æµ‹å†…å®¹ |
|--------|---------|---------|---------|
| SQL001 | SQLæ³¨å…¥ | High | å­—ç¬¦ä¸²æ‹¼æ¥SQLè¯­å¥ |
| CMD001 | å‘½ä»¤æ³¨å…¥ | Critical | os.systemç­‰å±é™©å‡½æ•° |
| SEC001 | ç¡¬ç¼–ç å¯†é’¥ | High | ç¡¬ç¼–ç çš„å¯†ç /Token |
| DNG001 | å±é™©å‡½æ•° | Critical | eval/exec/pickleç­‰ |
| PTH001 | è·¯å¾„éå† | Medium | æ–‡ä»¶æ“ä½œè·¯å¾„æœªæ ¡éªŒ |
| XSS001 | XSSé£é™© | Medium | æœªè½¬ä¹‰çš„HTMLè¾“å‡º |

### é™„å½•Bï¼šä½¿ç”¨ç¤ºä¾‹

```bash
# æ‰«æå•ä¸ªæ–‡ä»¶
python main.py scan app.py

# æ‰«ææ•´ä¸ªé¡¹ç›®
python main.py scan ./my_project

# ç”ŸæˆMarkdownæŠ¥å‘Š
python main.py scan ./my_project -o report.md

# åªå¯ç”¨ç‰¹å®šè§„åˆ™
python main.py scan ./my_project --rules SQL001,CMD001

# æŸ¥çœ‹æ‰€æœ‰è§„åˆ™
python main.py list-rules
```

### é™„å½•Cï¼šé¡¹ç›®Gitæäº¤è®°å½•

```
* feat: æ·»åŠ XSSæ£€æµ‹è§„åˆ™
* feat: å®ç°è·¯å¾„éå†æ£€æµ‹
* feat: æ·»åŠ MarkdownæŠ¥å‘Šç”Ÿæˆå™¨
* refactor: é‡æ„è§„åˆ™å¼•æ“æ¶æ„
* feat: å®ç°å±é™©å‡½æ•°æ£€æµ‹è§„åˆ™
* feat: å®ç°ç¡¬ç¼–ç å¯†é’¥æ£€æµ‹
* feat: å®ç°å‘½ä»¤æ³¨å…¥æ£€æµ‹è§„åˆ™
* feat: å®ç°SQLæ³¨å…¥æ£€æµ‹è§„åˆ™
* feat: æ­å»ºé¡¹ç›®åŸºç¡€æ¡†æ¶
* docs: æ·»åŠ é¡¹ç›®æ–‡æ¡£
* init: åˆå§‹åŒ–é¡¹ç›®
```

---

*æ–‡æ¡£å®Œ*
